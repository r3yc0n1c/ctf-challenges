#!/usr/bin/env python3
from Crypto.Util.number import *
from math import factorial, lcm, prod


def L(x, n):
    return (x-1) // n

def partial_decrypt(n, c, s, d):
    N = n**(s+1)
    m = pow(c, d, N)
    i = 0
    for j in range(1, s+1):
        t1 = L(m % n**(j+1), n)
        t2 = i
        for k in range(2, j+1):
            i -= 1
            t2 = (t2 * i) % n**j
            kf = factorial(k)
            num = t2 * pow(n, k-1)
            denom = inverse(kf, n**j)
            t1 = (t1 - num*denom) % n**j
        i = t1
    return i

def decrypt(c, pub, priv):
    n, g, s = pub
    _, d = priv
    jd = partial_decrypt(n, g, s, d)
    jmd = partial_decrypt(n, c, s, d)
    m = jmd * inverse(jd, n**s) % n**s
    return m

"""
Factor N using ROCA Attack
Calculate d = LCM(p-1, q-1)
priv = (N, d)
"""
priv = (6987123650187575182209446282681517813867793721499151269457173257935344134169595434693172954005911889432109341164087125177611864032251819, 3493561825093787591104723141340758906933896860749575634728586628967581119253770520600464707986645260311953900927351045301984389832720272)
pub = (6987123650187575182209446282681517813867793721499151269457173257935344134169595434693172954005911889432109341164087125177611864032251819, 154185461095184042912548789529374561682630915469196549466797111260252523677212450423558781453510760227266792785846042170941292250771282435635137457159319251071041490137705158886981380098815722617795765077654347202989724460689463882334574750509579889285797642785973965711563581659205406568712949380305831614985581724963179889693112084724455516642000314906960159390246818670522292135731946553473568467106185403, 2)
enc = [9265409127023484599655718350389122056223881928454559279749560175092646345705726973474648012257589174268576054490019738857136184359231040020318600177451176639239736875762765934762489422918656383737115580128370139849998488571776351870045613617035643213171151913816432117606688884799519337935200583444326233765812507708479030454173934132458127587326822825570826878496996842706497263381061257449122481668605945, 201671823687552300693107989572294380310303496993961414744504749191971700027578786494456474070841364855596951165466407053005808142656561905800980795859832494467602341623456586345745753983380322860647636600702362566028857311113195022457954925309158503733287416832627728213718359057309020178797697500676122025207196374093523721133320721341108855117439394963714961880558508426460369584176352249783050500969077591, 93341884852613127862324880766873602453736323506291376998200009145714396078184645038309019407121788705289725690741258082531010923204882186835279499936129621765581302219810461838767675764699600167750743157180350106092181092383314756930928017124185493510309931720937591688829963962956846581636277537634734678534526156604923882724323320785977987748870182880494028528787734322643727548612137044012827720777389475, 161457716399931796926975808616228865959520461737589066943125006587499638578272206324202185702693198226520144925868777216443937226822988539107778294111540930133304212541800596942490327987511399911991001730927869742782045397875261246219987818912811288435144069167693185200268273316443083650224848010103962948139359785706353976684626984751605976013937945067669715750640966132019771182369378501984042039126141942, 292376475881030053918896622880201336858412355425388492904913754497454536863369532990479528791942500872927399530353490151231827574385027273870506087078116187096096837848499904908630480515697588517450553082342999602789320354791794348104868670208583572508261457707009334580778459720594621853619428702994897510326214856889274259710085715709208345046726439802726546912580116653149240942551124857833215085006957528]
noise = [129095784359175014193608985342107301726946770015190751813981088239391587942578580276523608418311924373928676585174617948326478878549369051966681100160130681023540594754292366774217927345190741282828213497007594300735408331042651639108717827429097876269097630405329949914696412610701464077430634321056485154943711746730547018759577743979602347973567561805828575688049271324034877447061752587442268206656056908, 150375565283306702692233061901458991678236930148610118103084642369948286562714461830221245382871341208545778833043719164554090987758125507146678690486441842849305330961176405881796460172697821024342708774908496706325519426167316952748848945122067774517046730290577709205579471051512085947710272821827947239799492375105347456927625065156572999683585839612214576743625629224774652643173056144691722309756110054, 317016624776995777086453014300203824894727613491387887574081649561210615659246444807216985586782286385277589140240166888329076844960476762149495927485585397923933440707892604953711866607954210734599363081540193488880991914080429714283941699337840371279946293892179080469471924407465664387017970041164365100136501304262198441493164295188375478272579097930070227555033397528704177403235570641437150964438706625, 89090710814087894534357393453220172593183412271560600389975245455086630048908444090918602067382516193433502150545554512397193741960735382263620910347084864988271993443023766593503894209700447294623769473185162300656662488493850408492374145716627699543059408267258083863278843277280299770895694236494935108985086416986631098415438588066082367628006125735334410146274638888672709054884229856633276663927284607, 285129921357444448685910881667887052298116342753342003912476050727898658882599159632690897977411602364664953289878799431366673048429894487057901166260844941736641591913629087743312739244554902363684894614950797777438743041557627128883795135574761056279197748241409380119993541826499672768734526775036143801062451896054287235780349311029175249850895710202518699122022449444467437548279719520624080414044623361]

n = pub[0]
dec = [decrypt(c, pub, priv) for c in enc]
inv = [inverse(i, n) for i in noise]

m = prod(dec) * prod(inv) % n
m = long_to_bytes(m)
print(m)
